"use strict";function Queue(e){this.window=e,this.items=[],this.openingTab=!1}function Item(e,t,A,n,i){this.id=e,this.window=t,this.url=A,this.state=n,this.locked=i}function setLock(e,t,A){var n=getQueue(e).items;n.length>0&&(n[t].locked=A,cleanAndStore())}function moveItemInQueue(e,t,A){var n=getQueue(e).items;n.move(t,A),cleanAndStore()}function getQueue(e){for(var t=0;t<queues.length;t++)if(queues[t].window!==DEFAULT_ID&&queues[t].window==e)return queues[t];var A=new Queue(e);return queues.push(A),A}function findTabWaiting(e,t){for(var A=0;A<tabsWaiting.length;A++)if(e===tabsWaiting[A].id)return t&&tabsWaiting.splice(A,1),!0;return!1}function findInQueue(e,t){for(var A=0;A<e.length;A++)if(e[A].url===t)return A;return-1}function isInWhitelist(e){for(var t=0;t<whitelist.length;t++)if(whitelist[t].test(e))return!0;return!1}function removeQueue(e){queues.splice(e,1),cleanAndStore()}function clearQueues(){queues=[],cleanAndStore()}function clearSavedQueues(){for(var e=0;e<queues.length;)queues[e].window===DEFAULT_ID?queues.splice(e,1):e++;cleanAndStore()}function clearItems(e){var t=getQueue(e);t.items=[],cleanAndStore()}function queueTab(e){if(!isInWhitelist(e.url)){var t=new Item(e.id,e.windowId,e.url,e.status,!1);saveItem(t),isQueuing=!0,chrome.tabs.remove(e.id,function(){void 0!==chrome.runtime.lastError})}}function compareById(e,t){return e.id<t.id?-1:e.id>t.id?1:0}function queueToLimit(e){chrome.tabs.query({windowId:e,pinned:!1},function(e){for(var t=0;t<e.length;t++)isInWhitelist(e[t].url)&&(e.splice(t,1),t--);if(e.length>tabLimit){queueByRecent&&(e=e.sort(compareById));for(var t=tabLimit;t<e.length;t++)queueTab(e[t])}})}function saveItem(e){var t=getQueue(e.window).items;if(!allowDuplicates){var A=findInQueue(t,e.url);if(A>=0)return void t.move(A,0)}lifo?t.unshift(e):t.push(e),cleanAndStore()}function removeItem(e,t){var A=getQueue(e).items;A.splice(t,1),cleanAndStore()}function setActive(e){isActive=e,chrome.storage.local.set({isActive:isActive});var t=isActive?ICON_DEFAULT:ICON_DISABLED;isActive?setUpdater():window.clearInterval(updater),chrome.browserAction.setIcon({path:t})}function updateBadgeCounter(){chrome.tabs.query({currentWindow:!0,active:!0},function(e){var t=e[0];if(t){var A="#00ff00",n=getQueue(t.windowId).items;n.length>0&&(A="#ff0000"),chrome.browserAction.setBadgeBackgroundColor({color:A}),chrome.browserAction.setBadgeText({text:n.length.toString(),tabId:t.id})}})}function init(){function e(e){if(void 0!==chrome.runtime.lastError)return void console.error("An error ocurred initializing options: "+chrome.runtime.lastError.string);e.hasOwnProperty("tabLimit")&&(tabLimit=e.tabLimit),e.hasOwnProperty("lifo")&&(lifo=e.lifo),e.hasOwnProperty("allowDuplicates")&&(allowDuplicates=e.allowDuplicates),e.hasOwnProperty("queueByRecent")&&(queueByRecent=e.queueByRecent),e.hasOwnProperty("slowNetworkMode")&&(slowNetworkMode=e.slowNetworkMode),e.hasOwnProperty("slowNetworkLimit")&&(slowNetworkLimit=e.slowNetworkLimit),e.hasOwnProperty("isActive")&&(isActive=e.isActive);var t=isActive?ICON_DEFAULT:ICON_DISABLED;chrome.browserAction.setIcon({path:t}),e.hasOwnProperty("queues")&&(queues=JSON.parse(e.queues)),initQueues(),setUpdater(),isActive&&e.hasOwnProperty("restoreOnStart")&&e.restoreOnStart&&restoreSavedQueues(),e.hasOwnProperty("hideContextMenu")&&!e.hideContextMenu&&createContextMenu()}document.removeEventListener("DOMContentLoaded"),chrome.storage.local.get(null,e)}function initQueues(){if(0!==queues.length)for(var e=0;e<queues.length;e++){var t=queues[e];t.window=DEFAULT_ID;for(var A=0;A<t.items.length;A++)t.items[A].window=DEFAULT_ID}}function setUpdater(){updater=window.setInterval(function(){isActive&&(chrome.windows.getAll({populate:!0},function(e){for(var t=0;t<e.length;t++)"normal"!==e[t].type||checkingItems||(checkingItems=!0,checkOpenNextItems(e[t]),checkingItems=!1)}),updateBadgeCounter())},500)}function calculateFreespace(e){for(var t=0,A=0,n=0;n<e.length;n++)isInWhitelist(e[n].url)||e[n].pinned||(t++,"loading"===e[n].status&&A++);var i=tabLimit-t;if(i>0&&slowNetworkMode){var o=slowNetworkLimit-A;i>o&&(i=o)}return i}function checkOpenNextItems(e){if(0!=e.tabs.length){var t=getQueue(e.id).items,A=calculateFreespace(e.tabs);if(A>0&&t.length>0)for(var n=0;A>0&&n<t.length;)t[n].locked?n++:(chrome.tabs.create({windowId:e.id,url:t[n].url,active:!1}),removeItem(e.id,n),A--)}}function openUrlInTab(e,t,A,n,i){isOverriding=n,i?chrome.tabs.update({url:t}):A>-1?chrome.tabs.create({windowId:e,url:t,index:A,active:!1}):chrome.tabs.create({windowId:e,url:t,active:!1})}function openQueueInWindow(e){chrome.windows.create({focused:!1},function(t){e.window=t.id;for(var A=e.items,n=0;n<A.length;n++)A[n].window=t.id})}function restoreQueue(e){queues.length<=e||openQueueInWindow(queues[e])}function restoreSavedQueues(){for(var e=0;e<queues.length;e++)queues[e].window===DEFAULT_ID&&openQueueInWindow(queues[e])}function onSettingsChanged(e,t){var A,n,i;for(A in e)e.hasOwnProperty(A)&&(n=e[A],i=n.newValue,"tabLimit"===A?tabLimit=i:"lifo"===A?lifo=i:"allowDuplicates"===A?allowDuplicates=i:"queueByRecent"===A?queueByRecent=i:"hideContextMenu"===A?i?chrome.contextMenus.removeAll():createContextMenu():"slowNetworkMode"===A?slowNetworkMode=i:"slowNetworkLimit"===A&&(slowNetworkLimit=i))}function cleanAndStore(){if(!storing){storing=!0;var e=window.setTimeout(function(){for(var t=0;t<queues.length;)0===queues[t].items.length?queues.splice(t,1):t++;var A=JSON.stringify(queues);chrome.storage.local.set({queues:A},function(){void 0!==chrome.runtime.lastError&&(console.error("An error ocurred saving queues: "+chrome.runtime.lastError.string),console.error(chrome.runtime.lastError))}),window.clearTimeout(e),storing=!1},2e3)}}function createContextMenu(){chrome.contextMenus.create({title:"Open link in new tab (don't queue)",contexts:["link"],onclick:onContextMenuLinkClicked})}function onCreatedTab(e){isActive&&(isOverriding||tabsWaiting.push(e),isOverriding=!1)}function onUpdatedTab(e,t,A){isActive&&!t.pinned&&findTabWaiting(e,!0)&&chrome.tabs.query({windowId:A.windowId},function(e){for(var t=0,n=0;n<e.length;n++)isInWhitelist(e[n].url)||e[n].pinned||t++;tabLimit>=t||queueTab(A)})}function onWindowRemoved(e){var t=getQueue(e);if(t.items.length>0){t.window=DEFAULT_ID;for(var A=0;A<t.items.length;A++)t.items[A].window=DEFAULT_ID}}function onContextMenuLinkClicked(e,t){openUrlInTab(t.windowId,e.linkUrl,t.index+1,!0,!1)}function onInstalled(){function e(e){if(e.hasOwnProperty("queueLength")){for(var t=getQueue(DEFAULT_ID),A=["queueLength"],n=0;n<e.queueLength;n++){var i="item"+n,o=new Item(DEFAULT_ID,DEFAULT_ID,e[i],"complete",!1);A.push(i),t.items.push(o)}chrome.storage.local.remove(A,function(){return void 0!==chrome.runtime.lastError?(console.error("An error ocurred removing old storage keys: "+chrome.runtime.lastError.string),void console.error(chrome.runtime.lastError)):void 0}),cleanAndStore()}}chrome.storage.local.get(null,e)}var DEFAULT_ID=-1,whitelist=[/^chrome[:|-].*/],isActive=!0,isQueuing=!1,isOverriding=!1,storing=!1,updater=null,checkingItems=!1,tabsWaiting=[],tabLimit=10,lifo=!1,allowDuplicates=!1,slowNetworkMode=!1,slowNetworkLimit=0,queueByRecent=!1,queues=[],ICON_DEFAULT="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABmJLR0QA/wD/AP+gvaeTAAAAqElEQVR4nO3aQQrCQBBE0Y54/yOrW5GABI0fmfeWs2iKYtLMIjMAAMCKtpm5nzDz2afzT513+XDY31NAHaB23Tl7/ebe+fYO+anlb4AC6gC1vXeAHbASBdQBanvvgKOO7ozSNjO354Plb4AC6gA1BdQBagqoA9QUUAeoKaAOUFNAHaCmgDpATQF1gJoC6gA1BdQBagqoA9TO+Eforyx/AxRQBwAAACg8AEejCFAaFqVwAAAAAElFTkSuQmCC",ICON_DISABLED="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAABcVBMVEUAAAD/AAD///8AAAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAAAAAABAAADAAAGAAAKAAAPAAAVAAAcAAAiAAAjAAApAAAtAAA3AABCAABHAABQAABZAABjAABpAAB4AAB6AACHAACQAACbAACkAACxAAC9AAC/AADCAADIAADPAADXAADbAADjAADqAADuAADxAAD1AAD5AAD8AAD+AAD/AAB4L4E0AAAAUXRSTlMAAAABAQMFBgcJCgsMDQ8VFhweICUnKi0uNDY3QkNGTlJUVVhgYmVnaXh5iIuMj52foKGio66wsba5vb7CyMnKzM7W2drb4+bq6/Dz9ff5/P5esCL3AAABx0lEQVR42u3XR1MCQRCGYXoFs6yKGRRzzjlnESOOOeecxTy/Xl3Lni1Bl25ult9xtt7n1oe1aVHuHwgDgMVKm2OjArwB2ZkUBeCZkVL262wgd1J+bMTFBDL88nPjOSwgzSe/1ssB9GHsx1IVIMIM3hfyltKHfXBdGLO9L2Igrhv7h01BBxbasH/aEnRg/hT75x0RAthMCw8cY/+yJxjAocQdCAaw/4r9kWAAuy/YnwhrIGTbz9ifzYd8tQa2HrE/XxB0YOMe+8slQQdWg9jfLItIgG8HNKoOSDdebGox1oBzAHufC+hAvDqgiWygA44O7KfdQAfsjdjP5gMDqMU+UAwMoAr7uUpgABVzCFQBAygKYF8HDMAzi32TnQG4p7HvcAAdyPZj350AdCDdh/2gE+iAPmY+IDrgHFIHlAZ0ILEHe38W0AHTAU25gQ7YW9UBeYAB1KsDKgQGUK0OqBwYQKU0HRADKFEHVAMMoEAdUIOdAZgOqN0BJMDY5gP2F4si4iGwFsT+elnQgZU77G9XBAO4wj64KmiAZixn/OuAMuH3/fS/4Box+sk8YAKaPmAckMYGtOQuGfBqDAAX11KmWQP//41/EngDrVcKealcgDwAAAAASUVORK5CYII=";Array.prototype.move=function(e,t){for(;0>e;)e+=this.length;for(;0>t;)t+=this.length;if(t>=this.length)for(var A=t-this.length;A--+1;)this.push(void 0);return this.splice(t,0,this.splice(e,1)[0]),this},document.addEventListener("DOMContentLoaded",init),chrome.storage.onChanged.addListener(onSettingsChanged),chrome.tabs.onCreated.addListener(onCreatedTab),chrome.tabs.onUpdated.addListener(onUpdatedTab),chrome.windows.onRemoved.addListener(onWindowRemoved),chrome.runtime.onInstalled.addListener(onInstalled);